#!/bin/bash

export PATH="$PATH:/sbin:/usr/sbin/"

mv /tmp/crowbar_batch /tmp/barclamp_lib.rb /opt/dell/bin
cd /opt/dell
patch -p1 < /tmp/fix-chef-client-when-cluster-down.patch
/opt/dell/bin/barclamp_install.rb --rpm pacemaker

patch -p1 < /tmp/fix-crowbar_register.patch
mkdir -p /nfs
echo '/nfs <%= @admin_subnet %>/<%= @admin_netmask %>(rw,async,no_root_squash,no_subtree_check)' >> /opt/dell/chef/cookbooks/nfs-server/templates/default/exports.erb
/opt/dell/bin/barclamp_install.rb --rpm provisioner

sed -i 's/#resume_guests_state_on_host_boot=false/resume_guests_state_on_host_boot=true/' /opt/dell/chef/cookbooks/nova/templates/default/nova.conf.erb
/opt/dell/bin/barclamp_install.rb --rpm nova

/tmp/prep-admin.sh
/tmp/install-suse-cloud.sh
#/tmp/setup-node-sh-vars.sh

gem install /tmp/easy_diff-0.0.3.gem
