#!/bin/bash

export PATH="$PATH:/sbin:/usr/sbin/"

# atftp required at build-time for oemboot/suse-SLES11 bug
# but conflicts with tftp crowbar wants
zypper -n rm atftp

mv /tmp/crowbar_batch /tmp/barclamp_lib.rb /opt/dell/bin
gem install /tmp/easy_diff-0.0.3.gem

cd /opt/dell
patch -p1 < /tmp/fix-chef-client-when-cluster-down.patch

patch -p1 < /tmp/fix-crowbar_register.patch
mkdir -p /nfs/{postgresql,rabbitmq}
echo '/nfs <%= @admin_subnet %>/<%= @admin_netmask %>(rw,async,no_root_squash,no_subtree_check)' >> /opt/dell/chef/cookbooks/nfs-server/templates/default/exports.erb

/tmp/prep-admin.sh
/tmp/install-suse-cloud.sh
/tmp/setup-node-sh-vars.sh
